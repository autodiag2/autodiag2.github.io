<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üîê Secure Password Generator</title>
  <link rel="icon" href="/public/favicon.png" />
  <style>
    :root{
      --base03:#002b36;
      --base02:#073642;
      --base01:#586e75;
      --base00:#657b83;
      --base0:#839496;
      --base1:#93a1a1;
      --base2:#eee8d5;
      --base3:#fdf6e3;

      --yellow:#b58900;
      --orange:#cb4b16;
      --red:#dc322f;
      --magenta:#d33682;
      --violet:#6c71c4;
      --blue:#268bd2;
      --cyan:#2aa198;
      --green:#859900;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:var(--sans);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      transition: background .2s ease, color .2s ease;
    }

    body.light{
      color:var(--base00);
      background:
        radial-gradient(1000px 600px at 15% 0%, rgba(38,139,210,.18), transparent 60%),
        radial-gradient(900px 550px at 95% 20%, rgba(108,113,196,.14), transparent 60%),
        radial-gradient(800px 600px at 50% 100%, rgba(42,161,152,.10), transparent 60%),
        var(--base3);
      --text: var(--base00);
      --muted: var(--base01);
      --line: rgba(7,54,66,.18);
      --shadow: 0 18px 60px rgba(0,0,0,.12);
      --card: linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.58));
      --header: linear-gradient(180deg, rgba(38,139,210,.10), rgba(253,246,227,0));
      --panel: linear-gradient(180deg, rgba(238,232,213,.85), rgba(253,246,227,.75));
      --field: rgba(255,255,255,.85);
      --chip: rgba(255,255,255,.75);
      --btn: rgba(255,255,255,.80);
      --kbd: rgba(255,255,255,.70);
      --toast: rgba(253,246,227,.92);
      --ring: rgba(38,139,210,.12);
      --accent: var(--blue);
      --accent2: var(--violet);
      --ok: var(--green);
      --warn: var(--yellow);
      --bad: var(--red);
    }

    body.dark{
      color:var(--base0);
      background:
        radial-gradient(1000px 600px at 15% 0%, rgba(38,139,210,.20), transparent 60%),
        radial-gradient(900px 550px at 95% 20%, rgba(108,113,196,.18), transparent 60%),
        radial-gradient(800px 600px at 50% 100%, rgba(42,161,152,.14), transparent 60%),
        var(--base03);
      --text: var(--base0);
      --muted: rgba(147,161,161,.92);
      --line: rgba(147,161,161,.18);
      --shadow: 0 18px 60px rgba(0,0,0,.40);
      --card: linear-gradient(180deg, rgba(7,54,66,.70), rgba(0,43,54,.68));
      --header: linear-gradient(180deg, rgba(38,139,210,.14), rgba(0,43,54,0));
      --panel: linear-gradient(180deg, rgba(7,54,66,.65), rgba(0,43,54,.60));
      --field: rgba(7,54,66,.55);
      --chip: rgba(7,54,66,.55);
      --btn: rgba(7,54,66,.55);
      --kbd: rgba(7,54,66,.60);
      --toast: rgba(7,54,66,.92);
      --ring: rgba(38,139,210,.18);
      --accent: var(--cyan);
      --accent2: var(--violet);
      --ok: var(--green);
      --warn: var(--yellow);
      --bad: #fb7185;
    }

    .wrap{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
    }
    @media (max-width: 860px){ .wrap{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      border-radius:16px;
      overflow:hidden;
      backdrop-filter: blur(8px);
    }

    header{
      padding:18px 18px 12px 18px;
      border-bottom:1px solid var(--line);
      background:var(--header);
    }
    header h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:10px;
      color:inherit;
    }
    header p{
      margin:8px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }

    .main{
      padding:16px 18px 18px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .out{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:12px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .pwRow{
      display:flex;
      gap:10px;
      align-items:stretch;
    }

    .pw{
      flex:1;
      min-width:0;
      font-family:var(--mono);
      font-size:16px;
      padding:12px 12px;
      border-radius:12px;
      background:var(--field);
      border:1px solid var(--line);
      color:inherit;
      outline:none;
    }
    .pw:focus{
      border-color:rgba(38,139,210,.55);
      box-shadow:0 0 0 4px var(--ring);
    }

    .btn{
      border:1px solid var(--line);
      background:var(--btn);
      color:inherit;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      transition: transform .04s ease, background .15s ease, border-color .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ border-color:rgba(38,139,210,.45) }
    .btn:active{ transform: translateY(1px) }

    .btnPrimary{
      background:linear-gradient(90deg, rgba(38,139,210,.16), rgba(108,113,196,.12));
      border-color:rgba(38,139,210,.40);
    }

    .btnDanger:hover{ border-color:rgba(220,50,47,.55) }

    .btnSmall{ padding:8px 10px; border-radius:10px; font-size:13px }

    .metaRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--chip);
      color:var(--muted);
      font-size:12px;
      max-width:100%;
    }

    .dot{
      width:8px;height:8px;border-radius:999px;background:var(--warn);
      box-shadow:0 0 0 4px rgba(181,137,0,.12);
    }
    .dot.ok{ background:var(--ok); box-shadow:0 0 0 4px rgba(133,153,0,.12) }
    .dot.bad{ background:var(--bad); box-shadow:0 0 0 4px rgba(220,50,47,.10) }

    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:3px 6px;
      border-radius:6px;
      border:1px solid var(--line);
      background:var(--kbd);
      color:inherit;
      display:inline-block;
      max-width:100%;
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:break-all;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 560px){ .grid{grid-template-columns:1fr} }

    .section{
      background:var(--chip);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
    }
    .section h2{
      margin:0 0 10px 0;
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.2px;
      text-transform:uppercase;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 0;
      border-top:1px dashed rgba(7,54,66,.16);
    }
    body.dark .row{ border-top-color: rgba(147,161,161,.14) }
    .row:first-of-type{ border-top:none; padding-top:0 }
    .row label{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:14px;
      color:inherit;
      user-select:none;
    }
    .row .hint{ color:var(--muted); font-size:12px }

    .toggle{
      appearance:none;
      width:44px;height:26px;
      border-radius:999px;
      background:rgba(7,54,66,.10);
      border:1px solid var(--line);
      position:relative;
      outline:none;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease;
      min-width:50px;
    }
    body.dark .toggle{ background:rgba(147,161,161,.12) }
    .toggle:checked{
      background:rgba(42,161,152,.18);
      border-color:rgba(42,161,152,.45);
    }
    .toggle::after{
      content:"";
      position:absolute;
      width:20px;height:20px;
      top:50%;left:3px;
      transform:translateY(-50%);
      border-radius:999px;
      background:rgba(255,255,255,.95);
      border:1px solid rgba(7,54,66,.18);
      transition:left .15s ease;
    }
    body.dark .toggle::after{
      background:rgba(238,232,213,.92);
      border-color:rgba(147,161,161,.18);
    }
    .toggle:checked::after{ left:21px }

    input[type="number"], input[type="text"]{
      width:100%;
      font-size:14px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--field);
      color:inherit;
      outline:none;
    }
    input[type="number"]:focus, input[type="text"]:focus{
      border-color:rgba(38,139,210,.55);
      box-shadow:0 0 0 4px var(--ring);
    }

    .lenRow{
      display:grid;
      grid-template-columns: 1fr 110px;
      gap:10px;
      align-items:center;
    }

    input[type="range"]{ width:100%; accent-color: var(--accent); }

    .bar{
      height:10px;
      background:rgba(7,54,66,.10);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(7,54,66,.14);
    }
    body.dark .bar{
      background:rgba(147,161,161,.12);
      border-color:rgba(147,161,161,.14);
    }
    .bar > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(220,50,47,.90), rgba(181,137,0,.90), rgba(133,153,0,.90));
      transition: width .25s ease;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:999px;
      background:var(--toast);
      border:1px solid var(--line);
      color:inherit;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow:0 18px 50px rgba(0,0,0,.10);
      backdrop-filter: blur(10px);
    }
    body.dark .toast{ box-shadow:0 18px 60px rgba(0,0,0,.35) }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    .side{
      padding:16px 18px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .list{
      margin:0;
      padding-left:18px;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }

    .footerRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .sep{
      height:1px;
      background:rgba(7,54,66,.14);
      margin:8px 0;
    }
    body.dark .sep{ background:rgba(147,161,161,.14) }

    select{
      width:55%;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--field);
      color:inherit;
      outline:none;
    }
    select:focus{
      border-color:rgba(38,139,210,.55);
      box-shadow:0 0 0 4px var(--ring);
    }

    .themeToggleWrap{
      position:fixed;
      top:14px;
      right:14px;
      z-index:10;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--chip);
      box-shadow:0 10px 30px rgba(0,0,0,.08);
      backdrop-filter: blur(10px);
      user-select:none;
    }
    body.dark .themeToggleWrap{ box-shadow:0 10px 40px rgba(0,0,0,.30) }

    .themeLabel{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }

    .themeBtn{
      border:1px solid var(--line);
      background:var(--btn);
      color:inherit;
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .themeBtn:hover{ border-color:rgba(38,139,210,.45) }
  </style>
</head>
<body class="light">
  <div class="themeToggleWrap" aria-label="Theme toggle">
    <div class="themeLabel">
      <span aria-hidden="true" id="themeIcon">‚òÄÔ∏è</span>
      <span id="themeText">Light</span>
    </div>
    <button id="themeBtn" class="themeBtn" type="button" title="Toggle theme">Toggle</button>
  </div>

  <div class="wrap">
    <section class="card">
      <header>
        <h1><span aria-hidden="true">üîê</span> Secure Password Generator</h1>
        <p>Client-side generator using <span class="kbd">window.crypto</span>. Press <span class="kbd">G</span> to generate, <span class="kbd">C</span> to copy.</p>
      </header>

      <div class="main">
        <div class="out">
          <div class="pwRow">
            <input id="pw" class="pw" type="text" spellcheck="false" autocomplete="off" aria-label="Generated password" />
            <button id="copy" class="btn btnPrimary" type="button" title="Copy to clipboard (C)"><span aria-hidden="true">üìã</span><span>Copy</span></button>
            <button id="gen" class="btn" type="button" title="Generate (G)"><span aria-hidden="true">‚ö°</span><span>Generate</span></button>
          </div>

          <div class="metaRow">
            <div class="chip" id="strengthChip">
              <span class="dot" id="strengthDot"></span>
              <span id="strengthLabel">Strength: ‚Äî</span>
              <span class="kbd" id="entropyLabel">‚Äî</span>
            </div>
            <div class="chip">
              <span aria-hidden="true">‚åõ</span>
              <span id="policyLabel">Policy: default</span>
            </div>
          </div>

          <div class="bar" aria-label="Strength meter"><div id="meterFill"></div></div>
        </div>

        <div class="grid">
          <div class="section">
            <h2>Length</h2>
            <div class="lenRow">
              <input id="len" type="range" min="8" max="64" value="20" />
              <input id="lenNum" type="number" min="8" max="64" value="20" />
            </div>
            <div class="hint" style="margin-top:8px;color:var(--muted);font-size:12px">
              Recommended: 16‚Äì24 for most accounts; 24+ for high value.
            </div>
          </div>

          <div class="section">
            <h2>Preset</h2>
            <div class="row" style="padding-top:0">
              <label for="preset">Choose</label>
              <select id="preset">
                <option value="default" selected>Default (recommended)</option>
                <option value="pin">PIN (digits only)</option>
                <option value="memorable">Memorable (words + digits)</option>
                <option value="legacy">Legacy-safe (no ambiguous)</option>
              </select>
            </div>
            <div class="hint" style="margin-top:8px;color:var(--muted);font-size:12px">
              Presets adjust toggles automatically; you can tweak afterwards.
            </div>
          </div>

          <div class="section">
            <h2>Character sets</h2>
            <div class="row">
              <label><input id="lower" class="toggle" type="checkbox" checked /> Lowercase</label>
              <span class="hint">a‚Äìz</span>
            </div>
            <div class="row">
              <label><input id="upper" class="toggle" type="checkbox" checked /> Uppercase</label>
              <span class="hint">A‚ÄìZ</span>
            </div>
            <div class="row">
              <label><input id="digits" class="toggle" type="checkbox" checked /> Digits</label>
              <span class="hint">0‚Äì9</span>
            </div>
            <div class="row">
              <label><input id="symbols" class="toggle" type="checkbox" checked /> Symbols</label>
              <span class="hint">!@#$‚Ä¶</span>
            </div>
          </div>

          <div class="section">
            <h2>Options</h2>
            <div class="row">
              <label><input id="noAmb" class="toggle" type="checkbox" /> Avoid ambiguous</label>
              <span class="hint">O/0, l/1, I</span>
            </div>
            <div class="row">
              <label><input id="requireAll" class="toggle" type="checkbox" checked /> Require each selected set</label>
              <span class="hint">enforces policy</span>
            </div>
            <div class="row">
              <label><input id="noRepeat" class="toggle" type="checkbox" /> Avoid repeats</label>
              <span class="hint">best effort</span>
            </div>
            <div class="row">
              <label for="customSymbols" style="flex:1;justify-content:space-between;width:100%">
                <span>Symbols</span>
              </label>
            </div>
            <input id="customSymbols" type="text" value="!@#$%^&*()-_=+[]{};:,.?/|~" />
            <div class="hint" style="margin-top:8px;color:var(--muted);font-size:12px">
              Leave empty to use the default set above.
            </div>
          </div>
        </div>

        <div class="footerRow">
          <button id="regen" class="btn btnSmall" type="button" title="Generate and copy"><span aria-hidden="true">‚ú®</span><span>Generate + Copy</span></button>
          <button id="clear" class="btn btnSmall btnDanger" type="button" title="Clear output"><span aria-hidden="true">üßπ</span><span>Clear</span></button>
        </div>
      </div>
    </section>

    <aside class="card">
      <header>
        <h1><span aria-hidden="true">üß†</span> Details</h1>
        <p>Entropy estimate and quick checks. Generation uses rejection sampling for uniformity.</p>
      </header>
      <div class="side">
        <div class="section">
          <h2>Entropy</h2>
          <div class="row" style="padding-top:0">
            <span class="hint">Alphabet size</span>
            <span class="kbd" id="alphaSize">‚Äî</span>
          </div>
          <div class="row">
            <span class="hint">Estimated bits</span>
            <span class="kbd" id="bits">‚Äî</span>
          </div>
          <div class="row">
            <span class="hint">Rough guesses</span>
            <span class="kbd" id="guesses">‚Äî</span>
          </div>
          <div class="sep"></div>
          <div class="hint" style="color:var(--muted);font-size:12px;line-height:1.5">
            Estimate assumes independent uniform choices from the final alphabet and does not model site-specific rules.
          </div>
        </div>

        <div class="section">
          <h2>Tips</h2>
          <ul class="list">
            <li>Prefer a password manager, unique passwords per site.</li>
            <li>Length matters more than symbols.</li>
            <li>Use ‚ÄúLegacy-safe‚Äù for systems that reject some symbols.</li>
          </ul>
        </div>

        <div class="section">
          <h2>Keyboard</h2>
          <div class="row" style="padding-top:0"><span class="hint">Generate</span><span class="kbd">G</span></div>
          <div class="row"><span class="hint">Copy</span><span class="kbd">C</span></div>
          <div class="row"><span class="hint">Toggle symbols</span><span class="kbd">S</span></div>
        </div>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <span id="toastIcon" aria-hidden="true">‚úÖ</span>
    <span id="toastText">Copied</span>
  </div>

  <script>
    const $ = (id) => document.getElementById(id)

    const el = {
      pw: $("pw"),
      copy: $("copy"),
      gen: $("gen"),
      regen: $("regen"),
      clear: $("clear"),

      len: $("len"),
      lenNum: $("lenNum"),
      preset: $("preset"),

      lower: $("lower"),
      upper: $("upper"),
      digits: $("digits"),
      symbols: $("symbols"),

      noAmb: $("noAmb"),
      requireAll: $("requireAll"),
      noRepeat: $("noRepeat"),
      customSymbols: $("customSymbols"),

      meterFill: $("meterFill"),
      strengthLabel: $("strengthLabel"),
      strengthDot: $("strengthDot"),
      entropyLabel: $("entropyLabel"),
      policyLabel: $("policyLabel"),

      alphaSize: $("alphaSize"),
      bits: $("bits"),
      guesses: $("guesses"),

      toast: $("toast"),
      toastText: $("toastText"),
      toastIcon: $("toastIcon"),

      themeBtn: $("themeBtn"),
      themeText: $("themeText"),
      themeIcon: $("themeIcon"),
    }

    const AMBIGUOUS = new Set(["O","0","o","I","l","1","|"])
    const DEFAULT_SYMBOLS = "!@#$%^&*()-_=+[]{};:,.?/|~"
    const LEGACY_SAFE_SYMBOLS = "!@#$%*-_=+?."
    const WORDS = [
      "ember","river","crisp","shadow","cobalt","lunar","maple","velvet","orbit","frost",
      "harbor","echo","saffron","pixel","cedar","breeze","atlas","nova","quartz","solace"
    ]

    function toast(msg, icon="‚úÖ") {
      el.toastText.textContent = msg
      el.toastIcon.textContent = icon
      el.toast.classList.add("show")
      window.clearTimeout(toast._t)
      toast._t = window.setTimeout(() => el.toast.classList.remove("show"), 1200)
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)) }

    function setLength(v){
      const n = clamp(Number(v) || 20, Number(el.len.min), Number(el.len.max))
      el.len.value = String(n)
      el.lenNum.value = String(n)
      updateDerived()
    }

    function getSymbols(){
      const cs = (el.customSymbols.value || "").trim()
      return cs.length ? cs : DEFAULT_SYMBOLS
    }

    function buildAlphabet(){
      let lower = "abcdefghijklmnopqrstuvwxyz"
      let upper = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
      let digits = "0123456789"
      let symbols = getSymbols()

      if (el.noAmb.checked){
        lower = [...lower].filter(c => !AMBIGUOUS.has(c)).join("")
        upper = [...upper].filter(c => !AMBIGUOUS.has(c)).join("")
        digits = [...digits].filter(c => !AMBIGUOUS.has(c)).join("")
        symbols = [...symbols].filter(c => !AMBIGUOUS.has(c)).join("")
      }

      const sets = []
      if (el.lower.checked) sets.push({ name:"lower", chars: lower })
      if (el.upper.checked) sets.push({ name:"upper", chars: upper })
      if (el.digits.checked) sets.push({ name:"digits", chars: digits })
      if (el.symbols.checked) sets.push({ name:"symbols", chars: symbols })

      const all = sets.map(s => s.chars).join("")
      return { sets, all }
    }

    function cryptoInt(maxExclusive){
      if (maxExclusive <= 0) throw new Error("bad max")
      const max = maxExclusive >>> 0
      const lim = 0x100000000 - (0x100000000 % max)
      const buf = new Uint32Array(1)
      while (true){
        crypto.getRandomValues(buf)
        const x = buf[0]
        if (x < lim) return x % max
      }
    }

    function pick(chars){
      return chars[cryptoInt(chars.length)]
    }

    function shuffle(arr){
      for (let i = arr.length - 1; i >= 1; i--){
        const j = cryptoInt(i + 1)
        const t = arr[i]; arr[i] = arr[j]; arr[j] = t
      }
      return arr
    }

    function generatePassword(){
      const length = clamp(Number(el.len.value) || 20, 1, 256)
      const { sets, all } = buildAlphabet()

      if (sets.length === 0) throw new Error("Select at least one character set.")
      if (all.length < 2 && length > 1) throw new Error("Alphabet too small.")
      if (el.requireAll.checked && length < sets.length) throw new Error("Length is shorter than required sets.")

      const out = []
      const used = new Map()

      const addChar = (c) => {
        if (!el.noRepeat.checked) { out.push(c); return }
        const n = (used.get(c) || 0) + 1
        used.set(c, n)
        if (n > 1) return false
        out.push(c)
        return true
      }

      if (el.requireAll.checked){
        for (const s of sets){
          let c = pick(s.chars)
          if (el.noRepeat.checked){
            let tries = 0
            while (tries < 200 && used.has(c)){
              c = pick(s.chars); tries++
            }
          }
          addChar(c)
        }
      }

      while (out.length < length){
        let c = pick(all)
        if (el.noRepeat.checked){
          let tries = 0
          while (tries < 200 && used.has(c)){
            c = pick(all); tries++
          }
          if (used.has(c)) {
            out.push(c)
            continue
          }
        }
        addChar(c)
      }

      shuffle(out)
      return out.join("")
    }

    function log2(x){ return Math.log(x) / Math.log(2) }

    function formatBigInt(n){
      const s = n.toString()
      if (s.length <= 4) return s
      const parts = []
      for (let i = s.length; i > 0; i -= 3){
        parts.push(s.substring(Math.max(0, i - 3), i))
      }
      return parts.reverse().join(",")
    }

    function updateStrength(pw){
      const { all } = buildAlphabet()
      const length = pw.length
      const alpha = all.length
      const bits = alpha > 0 ? length * log2(alpha) : 0

      el.alphaSize.textContent = String(alpha || "‚Äî")
      el.bits.textContent = alpha ? `${bits.toFixed(1)} bits` : "‚Äî"

      let guesses = 0n
      if (alpha > 0 && length > 0){
        guesses = BigInt(alpha) ** BigInt(length)
      }
      el.guesses.textContent = alpha ? `~${formatBigInt(guesses)}` : "‚Äî"

      let label = "Weak"
      let dot = "bad"
      let meter = 18

      if (bits >= 80){ label = "Strong"; dot = "ok"; meter = 92 }
      else if (bits >= 60){ label = "Good"; dot = ""; meter = 72 }
      else if (bits >= 45){ label = "Fair"; dot = ""; meter = 52 }

      el.strengthLabel.textContent = `Strength: ${label}`
      el.entropyLabel.textContent = alpha ? `${bits.toFixed(1)}b` : "‚Äî"
      el.meterFill.style.width = `${clamp(meter, 0, 100)}%`

      el.strengthDot.classList.remove("ok","bad")
      if (dot) el.strengthDot.classList.add(dot)

      el.policyLabel.textContent =
        `Policy: ${el.preset.value}` +
        `${el.requireAll.checked ? ", require all" : ""}` +
        `${el.noAmb.checked ? ", no ambiguous" : ""}`
    }

    function updateDerived(){
      updateStrength(el.pw.value || "")
    }

    async function copyToClipboard(text){
      if (!text) throw new Error("Nothing to copy.")
      if (navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text)
        return
      }
      const ta = document.createElement("textarea")
      ta.value = text
      ta.style.position = "fixed"
      ta.style.left = "-9999px"
      ta.style.top = "0"
      document.body.appendChild(ta)
      ta.focus()
      ta.select()
      const ok = document.execCommand("copy")
      document.body.removeChild(ta)
      if (!ok) throw new Error("Copy failed.")
    }

    function applyPreset(name){
      if (name === "pin"){
        setLength(6)
        el.lower.checked = false
        el.upper.checked = false
        el.digits.checked = true
        el.symbols.checked = false
        el.noAmb.checked = false
        el.requireAll.checked = true
        el.noRepeat.checked = false
        el.customSymbols.value = DEFAULT_SYMBOLS
      } else if (name === "memorable"){
        setLength(24)
        el.lower.checked = true
        el.upper.checked = true
        el.digits.checked = true
        el.symbols.checked = false
        el.noAmb.checked = true
        el.requireAll.checked = true
        el.noRepeat.checked = false
        el.customSymbols.value = DEFAULT_SYMBOLS
      } else if (name === "legacy"){
        setLength(20)
        el.lower.checked = true
        el.upper.checked = true
        el.digits.checked = true
        el.symbols.checked = true
        el.noAmb.checked = true
        el.requireAll.checked = true
        el.noRepeat.checked = false
        el.customSymbols.value = LEGACY_SAFE_SYMBOLS
      } else {
        setLength(20)
        el.lower.checked = true
        el.upper.checked = true
        el.digits.checked = true
        el.symbols.checked = true
        el.noAmb.checked = false
        el.requireAll.checked = true
        el.noRepeat.checked = false
        el.customSymbols.value = DEFAULT_SYMBOLS
      }
      updateDerived()
      generateIntoField()
    }

    function generateMemorable(){
      const nWords = 3
      const parts = []
      for (let i = 0; i < nWords; i++){
        parts.push(WORDS[cryptoInt(WORDS.length)])
      }
      const joiners = ["-","_","."]
      const j = joiners[cryptoInt(joiners.length)]
      const cap = (s) => s.length ? s[0].toUpperCase() + s.slice(1) : s
      let base = cap(parts[0]) + j + parts[1] + j + cap(parts[2]) + String(cryptoInt(10)) + String(cryptoInt(10))

      const needLen = clamp(Number(el.len.value) || 24, 12, 64)
      if (base.length < needLen){
        const padAlphabet = "abcdefghijklmnopqrstuvwxyz0123456789"
        while (base.length < needLen) base += pick(padAlphabet)
      } else if (base.length > needLen){
        base = base.slice(0, needLen)
      }
      return base
    }

    function generateIntoField(){
      try{
        if (el.preset.value === "memorable") el.pw.value = generateMemorable()
        else el.pw.value = generatePassword()
        updateStrength(el.pw.value)
      } catch (e){
        toast(e.message || String(e), "‚ö†Ô∏è")
      }
    }

    function setTheme(mode){
      const m = (mode === "dark") ? "dark" : "light"
      document.body.classList.toggle("dark", m === "dark")
      document.body.classList.toggle("light", m === "light")
      el.themeText.textContent = m === "dark" ? "Dark" : "Light"
      el.themeIcon.textContent = m === "dark" ? "üåô" : "‚òÄÔ∏è"
      try { localStorage.setItem("theme", m) } catch {}
    }

    function initTheme(){
      let saved = null
      try { saved = localStorage.getItem("theme") } catch {}
      if (saved === "light" || saved === "dark"){
        setTheme(saved)
        return
      }
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches
      setTheme(prefersDark ? "dark" : "light")
    }

    function bindThemeAuto(){
      if (!window.matchMedia) return
      const mql = window.matchMedia("(prefers-color-scheme: dark)")
      const onChange = (e) => {
        let saved = null
        try { saved = localStorage.getItem("theme") } catch {}
        if (saved === "light" || saved === "dark") return
        setTheme(e.matches ? "dark" : "light")
      }
      if (mql.addEventListener) mql.addEventListener("change", onChange)
      else if (mql.addListener) mql.addListener(onChange)
    }

    el.len.addEventListener("input", (e) => setLength(e.target.value))
    el.lenNum.addEventListener("input", (e) => setLength(e.target.value))

    ;[el.lower, el.upper, el.digits, el.symbols, el.noAmb, el.requireAll, el.noRepeat, el.customSymbols].forEach(x => {
      x.addEventListener("input", updateDerived)
      x.addEventListener("change", updateDerived)
    })

    el.preset.addEventListener("change", () => applyPreset(el.preset.value))
    el.gen.addEventListener("click", generateIntoField)

    el.clear.addEventListener("click", () => {
      el.pw.value = ""
      updateDerived()
      toast("Cleared", "üßπ")
    })

    el.copy.addEventListener("click", async () => {
      try{
        await copyToClipboard(el.pw.value)
        toast("Copied to clipboard", "‚úÖ")
      } catch (e){
        toast(e.message || "Copy failed", "‚ö†Ô∏è")
      }
    })

    el.regen.addEventListener("click", async () => {
      generateIntoField()
      try{
        await copyToClipboard(el.pw.value)
        toast("Generated and copied", "‚ú®")
      } catch {
        toast("Generated (copy blocked)", "‚ö†Ô∏è")
      }
    })

    el.themeBtn.addEventListener("click", () => {
      const isDark = document.body.classList.contains("dark")
      setTheme(isDark ? "light" : "dark")
    })

    document.addEventListener("keydown", async (e) => {
      if (e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT")) return
      const k = e.key.toLowerCase()
      if (k === "g"){
        e.preventDefault()
        generateIntoField()
      } else if (k === "c"){
        e.preventDefault()
        try{
          await copyToClipboard(el.pw.value)
          toast("Copied to clipboard", "‚úÖ")
        } catch (err){
          toast(err.message || "Copy failed", "‚ö†Ô∏è")
        }
      } else if (k === "s"){
        e.preventDefault()
        el.symbols.checked = !el.symbols.checked
        updateDerived()
        generateIntoField()
      } else if (k === "t"){
        e.preventDefault()
        const isDark = document.body.classList.contains("dark")
        setTheme(isDark ? "light" : "dark")
      }
    })

    initTheme()
    bindThemeAuto()

    if (!window.crypto || !window.crypto.getRandomValues){
      toast("This browser lacks secure randomness (crypto.getRandomValues).", "‚õî")
      el.gen.disabled = true
      el.copy.disabled = true
      el.regen.disabled = true
    } else {
      applyPreset("default")
    }
  </script>
</body>
</html>
